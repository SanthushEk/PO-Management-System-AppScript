<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
      body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 40px auto;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    h2 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      color: #1e3a5f;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
      margin: 0 5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-landing {
      background: #1976D2;
    }

    .btn-vendor {
      background: #388E3C;
    }

    .btn-po {
      background: #1565C0;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    input,
    select {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      flex: 1;
      min-width: 150px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
    }

    th {
      background: #1976D2;
      color: white;
      text-transform: uppercase;
    }

    tr:nth-child(even) {
      background: #e3f2fd;
    }

    tr:hover {
      background: #bbdefb;
      transition: 0.3s;
    }

    /* Table Action Buttons */
    .action-btn {
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 6px;
      margin: 0 2px;
      color: white;
      font-size: 14px;
    }

    .action-btn.edit {
      background: #facc15;
    }

    .action-btn.edit:hover {
      background: #eab308;
    }

    .action-btn.delete {
      background: #ef4444;
    }

    .action-btn.delete:hover {
      background: #dc2626;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      opacity: 0;
      transition: 0.5s;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(-20px);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-box {
      background: #ffffff;
      width: 400px;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
      animation: popIn 0.3s ease;
    }

    .modal-box h3 {
      margin-top: 0;
      color: #2c3e50;
      text-align: center;
    }

    .modal-body input {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    @keyframes popIn {
      from {
        transform: scale(0.85);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Landing Page Cards */
    .landing-wrapper {
      text-align: center;
      padding: 40px 20px;
    }

    .landing-title {
      font-size: 28px;
      font-weight: 700;
      color: #1e3a5f;
      margin-bottom: 8px;
    }

    .landing-subtitle {
      color: #607d8b;
      font-size: 15px;
      margin-bottom: 40px;
    }

    .landing-actions {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
    }

    .action-card {
      width: 240px;
      height: 180px;
      background: linear-gradient(135deg, #388E3C, #2E7D32);
      color: #fff;
      border-radius: 14px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      font-weight: 500;
    }

    .action-card i {
      font-size: 42px;
      margin-bottom: 15px;
    }

    .action-card span {
      font-size: 16px;
      letter-spacing: 0.5px;
    }

    .action-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.25);
    }

    /* Page Display */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

  </style>
</head>

<body>

  <div class="container">

    <!-- Landing Page -->
    <div id="landingPage" class="page active">
      <div class="landing-wrapper">
        <h2 class="landing-title">Purchase Order Management System</h2>
        <p class="landing-subtitle">
          Streamline vendors, purchase orders, and approvals in one platform
        </p>

        <div class="landing-actions">
          <div class="action-card" onclick="showPage('vendorPage')">
            <i class="fas fa-industry"></i>
            <span>Vendor Management</span>
          </div>

          <div class="action-card" style="background: linear-gradient(135deg,#1565C0,#0D47A1);"
            onclick="showPage('poPage')">
            <i class="fas fa-file-invoice-dollar"></i>
            <span>PO Management</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Vendor Page -->
    <div id="vendorPage" class="page">
      <h2>Vendor Management</h2>

      <div class="input-group">
        <button class="btn btn-vendor" onclick="openVendorModal()">
          <i class="fa fa-plus"></i> Add Vendor
        </button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Vendor ID</th>
            <th>Vendor Name</th>
            <th>Contact Person</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="vendorTable"></tbody>
      </table>

      <div style="text-align:center; margin-top:20px;">
        <button class="btn btn-landing" onclick="showPage('landingPage')">
          Back to Home
        </button>
      </div>
    </div>

    <!-- Vendor Modal -->
    <div id="vendorModal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="modalTitle">Add New Vendor</h3>
        <div class="modal-body">
          <div class="input-group">
            <input type="text" id="modalVendorId" placeholder="Vendor ID" readonly>
            <button class="btn btn-po" onclick="generateVendorId()">
              <i class="fa fa-bolt"></i> Generate
            </button>
          </div>
          <input type="text" id="modalVendorName" placeholder="Vendor Name">
          <input type="text" id="modalContactPerson" placeholder="Contact Person">
          <input type="email" id="modalVendorEmail" placeholder="Email">
          <input type="text" id="modalVendorPhone" placeholder="Phone">
          <input type="text" id="modalVendorAddress" placeholder="Address">
        </div>

        <div class="modal-actions">
          <button class="btn btn-landing" onclick="closeVendorModal()">Cancel</button>
          <button class="btn btn-vendor" onclick="submitVendor()">
            Submit <i class="fa fa-check"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- PO Page -->
    <div id="poPage" class="page">
      <h2>Purchase Order Management</h2>

      <div class="input-group">
        <button class="btn btn-po" onclick="openPOModal()">
      <i class="fa fa-plus"></i> Add Purchase Order
    </button>
      </div>

      <table>
        <thead>
          <tr>
            <th>PO ID</th>
            <th>Vendor ID</th>
            <th>Item</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Status</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="poTable"></tbody>
      </table>


      <div style="text-align:center; margin-top:20px;">
        <button class="btn btn-landing" onclick="showPage('landingPage')">Back to Home</button>
      </div>
    </div>

    <!-- Add/Edit PO Modal -->
    <div id="poModal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="poModalTitle">Add New Purchase Order</h3>

        <div class="modal-body">
          <div class="input-group">
            <input type="text" id="modalPOId" placeholder="PO ID" readonly>
            <button class="btn btn-po" onclick="generatePOId()">
          <i class="fa fa-bolt"></i> Generate
        </button>
          </div>

          <select id="modalVendorSelect">
        <option value="">Select Vendor</option>
      </select>
          <input type="text" id="modalItem" placeholder="Item Name">
          <input type="number" id="modalQty" placeholder="Quantity">
          <input type="number" id="modalPrice" placeholder="Price">
        </div>

        <div class="modal-actions">
          <button class="btn btn-landing" onclick="closePOModal()">Cancel</button>
          <button class="btn btn-po" onclick="submitPO()">
        Submit <i class="fa fa-check"></i>
      </button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>


    <script>
      // -------------------- Cached Data --------------------
  let vendors = [];  // vendor list cache

  // -------------------- Initial Load --------------------
  document.addEventListener('DOMContentLoaded', function() {
    loadVendorsTable();  // load vendor table
    loadVendorOptions(() => { // load vendors cache first
      loadPOs();           // then load POs
    });
  });

  // -------------------- Toast Notification --------------------
  function showToast(msg){
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
  }

  // -------------------- Page Switching --------------------
  function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');

    if(pageId === 'vendorPage') loadVendorsTable();
    if(pageId === 'poPage') {
      loadVendorOptions(() => loadPOs());
    }
  }

  // -------------------- Vendor Functions --------------------
  function generateVendorId() {
    const timestamp = Date.now().toString().slice(-5);
    const random = Math.floor(100 + Math.random() * 900);
    document.getElementById("modalVendorId").value = `VND-${timestamp}-${random}`;
  }

  function openVendorModal() {
    document.getElementById("vendorModal").classList.add("show");
  }

  function closeVendorModal() {
    document.getElementById("vendorModal").classList.remove("show");
    document.getElementById("modalVendorId").value = "";
    document.getElementById("modalVendorName").value = "";
    document.getElementById("modalContactPerson").value = "";
    document.getElementById("modalVendorEmail").value = "";
    document.getElementById("modalVendorPhone").value = "";
    document.getElementById("modalVendorAddress").value = "";
  }

  function submitVendor() {
    const submitBtn = document.querySelector("#vendorModal .btn-vendor");
    submitBtn.disabled = true;
    submitBtn.innerHTML = "Saving...";

    const vendor = {
      id: document.getElementById("modalVendorId").value.trim(),
      name: document.getElementById("modalVendorName").value.trim(),
      contact: document.getElementById("modalContactPerson").value.trim(),
      email: document.getElementById("modalVendorEmail").value.trim(),
      phone: document.getElementById("modalVendorPhone").value.trim(),
      address: document.getElementById("modalVendorAddress").value.trim()
    };

    if(Object.values(vendor).some(v => v === "")) {
      alert("Please fill all vendor details");
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Submit <i class="fa fa-check"></i>';
      return;
    }

    google.script.run
      .withSuccessHandler(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Submit <i class="fa fa-check"></i>';
        closeVendorModal();
        loadVendorsTable();
        showToast("Vendor added successfully!");
      })
      .withFailureHandler(err => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Submit <i class="fa fa-check"></i>';
        alert("Error: " + err.message);
      })
      .addVendor(vendor);
  }

  function loadVendorsTable() {
    google.script.run.withSuccessHandler(data => {
      vendors = data; // update cache
      const tbody = document.getElementById('vendorTable');
      tbody.innerHTML = '';

      if(!data || data.length === 0){
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No Vendors Found</td></tr>';
        return;
      }

      data.forEach(v => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${v.id}</td>
          <td>${v.name}</td>
          <td>${v.contact}</td>
          <td>${v.email}</td>
          <td>${v.phone}</td>
          <td>${v.address}</td>
          <td>
            <i class="fa fa-trash action-btn delete" onclick="deleteVendor('${v.id}')"></i>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }).getVendors();
  }

  function deleteVendor(id) {
    if (!confirm("Are you sure you want to delete this vendor permanently?")) return;

    google.script.run.withSuccessHandler(() => {
      showToast("Vendor deleted successfully!");
      loadVendorsTable();
    }).deleteVendorById(id);
  }

  function loadVendorOptions(callback) {
    google.script.run.withSuccessHandler(data => {
      vendors = data;
      const select = document.getElementById('modalVendorSelect');
      select.innerHTML = '<option value="">Select Vendor</option>';
      vendors.forEach(v => {
        select.innerHTML += `<option value="${v.id}">${v.name}</option>`;
      });
      if(callback) callback();
    }).getVendors();
  }

  // -------------------- PO Functions --------------------
  function openPOModal() {
    document.getElementById('poModal').classList.add('show');
    document.getElementById('poModalTitle').textContent = 'Add New Purchase Order';
    document.getElementById('modalPOId').value = '';
    document.getElementById('modalVendorSelect').value = '';
    document.getElementById('modalItem').value = '';
    document.getElementById('modalQty').value = '';
    document.getElementById('modalPrice').value = '';
    loadVendorOptions(); // ensure dropdown populated
  }

  function closePOModal() {
    document.getElementById('poModal').classList.remove('show');
  }

  function generatePOId() {
    const timestamp = Date.now().toString().slice(-5);
    const random = Math.floor(100 + Math.random() * 900);
    document.getElementById("modalPOId").value = `PO-${timestamp}-${random}`;
  }

  function submitPO() {
    const po = {
      id: document.getElementById('modalPOId').value || Date.now(),
      vendorID: document.getElementById('modalVendorSelect').value,
      item: document.getElementById('modalItem').value.trim(),
      qty: document.getElementById('modalQty').value,
      price: document.getElementById('modalPrice').value,
      status: 'Pending',
      date: new Date().toISOString()
    };

    if(!po.vendorID || !po.item || !po.qty || !po.price) return showToast('Please fill all fields');

    google.script.run
      .withSuccessHandler(() => {
        showToast('PO added successfully!');
        closePOModal();
        loadPOs();
      })
      .withFailureHandler(err => showToast(err.message))
      .addPurchaseOrder(po.id, po.vendorID, po.item, po.qty, po.price);
  }

function loadPurchaseOrders() {
    google.script.run
      .withSuccessHandler(renderTable)
      .getPurchaseOrders();
  }

  function renderTable(data) {
    const tbody = document.getElementById("poTable");
    tbody.innerHTML = "";

    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8">No records found</td></tr>`;
      return;
    }

    data.forEach(po => {
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${po.poid}</td>
        <td>${po.vendorId}</td>
        <td>${po.item}</td>
        <td>${po.quantity}</td>
        <td>${po.price}</td>
        <td>${po.status}</td>
        <td>${po.date}</td>
        <td>
          <i class="fa-solid fa-trash delete-icon"
             title="Delete" onclick="confirmDelete('${po.poid}')"></i>
        </td>
      `;

      tbody.appendChild(row);
    });
  }

  function viewPO(poid) {
    alert("Selected PO: " + poid);
  }

  // Load data when page opens
  window.onload = loadPurchaseOrders;

function confirmDelete(poid) {
  const confirmAction = confirm(
    "Do you really want to delete this Purchase Order?\n\nThis action cannot be undone."
  );

  if (!confirmAction) return;

  google.script.run
    .withSuccessHandler(function (success) {
      if (success) {
        alert("Purchase Order deleted successfully.");
        loadPurchaseOrders(); // refresh table
      } else {
        alert("Delete failed. Record not found.");
      }
    })
    .withFailureHandler(function (err) {
      alert("Error deleting record.");
      console.error(err);
    })
    .deletePurchaseOrder(poid);
}

    </script>

</body>

</html>